<match kubernetes.var.log.containers.api-**>
  @type rewrite_tag_filter
  <rule>
    key     log_parsed.event
    pattern /^user:connect$/
    tag     metrics.api.userconnect
  </rule>
  <rule>
    key     log_parsed.severity
    pattern /^ERROR$/
    tag     metrics.api.error
  </rule>
  <rule>
    key     log_parsed.event
    pattern /^request$/
    tag     metrics.api.request
  </rule>
</match>

<filter kubernetes.var.log.containers.api-**>
  @type record_transformer
  enable_ruby true
  <record>
    metrics.user_connect ${record.dig("log_parsed", "event") == "user:connect" ? 1 : nil}
    metrics.error ${record.dig("log_parsed", "severity") == "ERROR" ? 1 : nil}
    metrics.req_res_status_code ${record.dig("log_parsed", "data", "response", "statusCode")}
    metrics.req_duration ${record.dig("log_parsed", "data", "duration")}
  </record>
</filter>
