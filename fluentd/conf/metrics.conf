<filter kubernetes.var.log.containers.api-**>
  @type parser
  key_name log
  reserve_time true
  reserve_data true
  hash_value_field log_parsed
  <parse>
    @type json
  </parse>
</filter>

<filter kubernetes.var.log.containers.api-**>
  @type record_transformer
  enable_ruby true
  <record>
    metrics_helper_user_connect ${record.dig("log_parsed", "event") == "user:connect" ? 1 : nil}
    metrics_helper_error ${record.dig("log_parsed", "severity") == "ERROR" ? 1 : nil}
  </record>
</filter>

<filter kubernetes.var.log.containers.api-**>
  @type prometheus
  <metric>
    name logapi_user_connect_count
    type counter
    desc Count of connections to DB to fetch user information
    key $.metrics_helper_user_connect
  </metric>
  <metric>
    name logapi_request_error_count
    type counter
    desc Count of requests, which ended with an error
    key $.metrics_helper_error
  </metric>
  <metric>
    name logapi_request_duration
    type histogram
    desc Duration of request
    key $.log_parsed.data.duration
    <labels>
      path $.log_parsed.data.request.url
      status_code $.log_parsed.data.response.statusCode
    </labels>
  </metric>
</filter>

# <filter kubernetes.var.log.containers.api-**>
#   @type stdout  # Print to stdout for debugging
# </filter>
